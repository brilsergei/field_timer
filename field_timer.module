<?php

/**
 * Implements hook_field_info
 */
function field_timer_field_info() {
  return array (
      'field_timer' => array (
          'label' => t('Timer Field'),
          'description' => t('Timer or countdown'),
          'settings' => array (),
          'instance_settings' => array (),
          'default_widget' => 'field_timer_simple_date',
          'default_formatter' => 'field_timer_text'
      )
  );
}

/**
 * Implements hook_field_widget_info
 */
function field_timer_field_widget_info() {
  return array (
      'field_timer_simple_date' => array (
          'label' => t('Date Form'),
          'field types' => array ('field_timer'),
          'settings' => array (),
          'weight' => -1
      ),
      'field_timer_entity_property_select' => array (
          'label' => t('Entity Property (Select List)'),
          'description' => t('Allow set an entity\'s property value as the target date.'),
          'field types' => array ('field_timer'),
          'settings' => array (),
          'weight' => 0
      ),
      'field_timer_entity_property_radio' => array (
          'label' => t('Entity Property (Radio Buttons)'),
          'description' => t('Allow set an entity\'s property value as the target date.'),
          'field types' => array ('field_timer'),
          'settings' => array (),
          'weight' => 0
      )
  );
}

/**
 * Implements hook_field_widget_form
 */
function field_timer_field_widget_form(&$form, &$form_state, $field, $instance,
        $langcode, $items, $delta, $element) {
  
  switch ($instance['widget']['type']) {
    case 'field_timer_simple_date': {
      $widget = array (
          '#type' => 'date_popup',
          '#title' => $element['#title'],
          '#default_value' => isset($items[$delta]['timestamp']) ? 
                  date('Y-m-d H:i:s', $items[$delta]['timestamp']) : NULL
      );
      $element['timestamp'] = $widget;
      break;
    }
    
    case 'field_timer_entity_property_select': {
      $options = field_timer_entity_properties($instance['entity_type']);
      $widget = array (
          '#type' => 'select',
          '#options' => $options,
          '#multiple' => FALSE,
          '#title' => $element['#title'],
          '#default_value' => isset($items[$delta]['entity_property']) ?
                  $items[$delta]['entity_property'] : 0,
          '#description' => t('Choose an entity property which will be used as the target date.'),
          '#empty_value' => 0
      );
      $element['entity_property'] = $widget;
      break;
    }
    case 'field_timer_entity_property_radio': {
      $options = field_timer_entity_properties($instance['entity_type']);
      $widget = array (
          '#type' => 'radios',
          '#options' => $options,
          '#default_value' => isset($items[$delta]['entity_property']) ?
                  $items[$delta]['entity_property'] : 0,
          '#description' => t('Choose an entity property which will be used as the target date.')
      );
      $element['entity_property'] = $widget;
      $element['#type'] = 'fieldset';
    }
  }

  return $element;
}

/**
 * Implements hook_field_formatter_info
 */
function field_timer_field_formatter_info() {
  $formatters = array (
      'field_timer_text' => array (
          'label' => t('Text'),
          'description' => t('Simple text'),
          'field types' => array ('field_timer'),
          'settings' => array (
              'type' => 'auto',
              'granularity' => 2
          )
      )
  );
  
  $path = libraries_get_path('county');
  if ($path && file_exists($path . '/js/county.js')) {
    $formatters['field_timer_county'] = array (
        'label' => t('County'),
        'description' => t('Use County jQuery plugin.'),
        'field types' => array ('field_timer'),
        'settings' => array (
            'animation' => 'fade',
            'speed' => 500,
            'theme' => 'blue',
            'background' => '',
            'reflection' => 1,
            'reflectionOpacity' => 0.2,
        )
    );
  }
 
  return $formatters;
}

/**
 * Implements hook_field_formatter_view
 */
function field_timer_field_formatter_view($entity_type, $entity, $field, $instance,
        $langcode, $items, $display) {
  
  $elements = array();
  $settings = $display['settings'];
  switch ($display['type']) {
    case 'field_timer_text': {
        foreach ($items as $delta => $item) {
          switch ($settings['type']) {
            case 'auto': {
              $interval = time() - $item['timestamp'];
              if ($interval > 0)
                $sign = '+';
              else
                $sign = '-';
              $time = $settings['label'].' '.$sign.
                      format_interval(abs($interval), $settings['granularity']);
              break;
            }
            case 'timer': {
              $time = $settings['label'].' '.
                      format_interval(time() - $item['timestamp'], $settings['granularity']);
              break;
            }
            case 'countdown': {
              $time = $settings['label'].' '.
                    format_interval($item['timestamp'] - time(), $settings['granularity']);
              break;
            }
          }
          $elements[$delta] = array (
              '#type' => 'markup',
              '#markup' => $time
          );
        }
      break;
    }
    
    case 'field_timer_county': {
      $info = entity_get_info($entity_type);
      $id_key = $info['entity keys']['id'];
      $settings = array();
      foreach ($items as $delta => $item) {
        $elements[$delta] = array(
            '#type' => 'markup',
            '#markup' => '<div id="county-'.
                $entity_type.'-'.$entity->{$id_key}.'-'.$delta.'" '.
                'style="background: '.$settings['background'].';"></div>'
        );
        $settings[$entity_type][$entity->{$id_key}][$delta] = $item['timestamp'];
      }
      $settings[$entity_type][$entity->{$id_key}]['options'] = $display['settings'];
      $settings[$entity_type][$entity->{$id_key}]['plugin'] = 'county';
      
      drupal_add_js(array ('field_timer' => $settings), 'setting');
      $path = libraries_get_path('county');
      drupal_add_js($path . '/js/county.js', 'file');
      drupal_add_js(drupal_get_path('module', 'field_timer').'/js/field_timer.js', 'file');
      drupal_add_css($path . '/css/county.css');
      break;
    }
  }
  return $elements;
}

/**
 * Implements hook_field_is_empty
 */
function field_timer_field_is_empty($item, $field) {
  if (empty($item['timestamp']) && empty ($item['entity_property']))
    return TRUE;
  return FALSE;
}

/**
 * Implements hook_field_presave
 */
function field_timer_field_presave($entity_type, $entity, $field, $instance,
        $langcode, &$items) {
  
  if ($field['type'] == 'field_timer') {
    foreach ($items as $delta => $item) {
      if (!empty($item['timestamp'])) {
        $timestamp = strtotime($item['timestamp']);
        if ($timestamp) {
          $items[$delta]['timestamp'] = $timestamp;
        }
      }
    }
  }
}

/**
 * Implements hook_field_load
 */
function field_timer_field_load($entity_type, $entities, $field, $instances,
        $langcode, &$items, $age) {
  
  foreach ($entities as $id => $entity) {
    foreach ($items[$id] as $delta => $item) {
      if (empty($item['timestamp']) && !empty($item['entity_property'])) {
        if (isset($entity->{$item['entity_property']}))
          $items[$id][$delta]['timestamp'] = $entity->{$item['entity_property']};
      }
    }
  }
}

/**
 * Implements hook_field_formatter_settings_summary
 */
function field_timer_field_formatter_settings_summary($field, $instance, $view_mode) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];
  $summary = array();
  
  switch ($display['type']) {
    case 'field_timer_text': {
      $types = array (
          'auto' => t('Auto'),
          'timer' => t('Timer'),
          'countdown' => t('Countdown')
      );
      $summary[] = t('Type: %type', array ('%type' => $types[$settings['type']]));

      $summary[] = t('Granularity: '.$settings['granularity']);

      return implode('<br/>', $summary);
    }
    
    case 'field_timer_county': {
      $animations = array(
          'fade' => t('Fade'),
          'scroll' => t('Scroll')
      );
      $summary[] = t('Animation: %animation', array ('%animation' => $animations[$settings['animation']]));
      $summary[] = t('Speed: %speed', array ('%speed' => $settings['speed'].'ms'));
      $themes = array (
          'black' => t('Black'),
          'gray' => t('Gray'),
          'red' => t('Red'),
          'blue' => t('Blue')
      );
      $summary[] = t('Theme: %theme', array ('%theme' => $themes[$settings['theme']]));
      $summary[] = t('Background: %css', array ('%css' => $settings['background']));
      $summary[] = t('Reflection: %state', array (
          '%state' => $settings['reflection'] ? 'Enabled' : 'Disabled'
      ));
      if ($settings['reflection'])
        $summary[] = t('Reflection opacity: %opacity', array (
            '%opacity' => $settings['reflectionOpacity']
        ));
      return implode($summary, '<br />');
    }
  }
}

/**
 * Implements hook_field_formatter_settings_form
 */
function field_timer_field_formatter_settings_form($field, $instance, $view_mode,
        $form, $form_state) {
  
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];
  
  switch ($display['type']) {
    case 'field_timer_text': {
      $settings_form['type'] = array (
          '#type' => 'select',
          '#title' => t('Type'),
          '#options' => array (
              'auto' => t('Auto'),
              'timer' => t('Timer'),
              'countdown' => t('Countdown')
          ),
          '#default_value' => $settings['type'],
      );

      $settings_form['granularity'] = array (
          '#type' => 'select',
          '#title' => t('Granularity'),
          '#options' => array (1 => 1, 2 => 2, 3 => 3, 4 => 4, 5 => 5, 6 => 6, 7 => 7),
          '#default_value' => $settings['granularity']
      );

      return $settings_form;
    }
    
    case 'field_timer_county': {
      $settings_form['animation'] = array (
          '#type' => 'select',
          '#title' => t('Animation'),
          '#options' => array (
              'fade' => t('Fade'),
              'scroll' => t('Scroll')
          ),
          '#default_value' => $settings['animation']
      );
      
      $settings_form['speed'] = array (
          '#type' => 'textfield',
          '#title' => t('Speed'),
          '#default_value' => $settings['speed']
      );
      
      $settings_form['theme'] = array (
          '#type' => 'select',
          '#title' => t('Theme'),
          '#options' => array (
              'black' => t('Black'),
              'gray' => t('Gray'),
              'red' => t('Red'),
              'blue' => t('Blue')
          ),
          '#default_value' => $settings['theme']
      );
      
      $settings_form['background'] = array (
          '#type' => 'textfield',
          '#title' => t('Background'),
          '#default_value' => $settings['background'],
          '#description' => t('Data from this field will be added to css property \'background\'.')
      );
      
      $settings_form['reflection'] = array (
          '#type' => 'checkbox',
          '#title' => t('Add reflection'),
          '#default_value' => $settings['reflection']
      );
      
      $settings_form['reflectionOpacity'] = array (
          '#type' => 'textfield',
          '#title' => t('Reflection opacity'),
          '#default_value' => $settings['reflectionOpacity'],
          '#description' => t('Float value between 0 and 1.')
      );
      return $settings_form;
    }
  }
}

/**
 * Implements hook_field_timer_entity_properties
 * Define properties for default drupal entities
 */
function field_timer_field_timer_entity_properties() {
  $properties = array (
      'node' => array (
          'created' => t('Node create date'),
          'changed' => t('Node last change date')
      ),
      'comment' => array (
          'created' => t('Comment create date'),
          'changed' => t('Comment last change date')
      ),
      'file' => array (
          'timestamp' => t('File upload date')
      ),
      'taxanomy_term' => array(),
      'taxanomy_vocabulary' => array(),
      'user' => array (
          'created' => t('User create date'),
          'access' => t('User last access date'),
          'login' => t('User last login date')
      )
  );
  
  return $properties;
}

/**
 * Load entity properties which represent a date.
 * @param string $entity_type
 * @return array of entity's properties which represent a date keyed 
 * by entity types if $entity_type is empty, array of properties of given 
 * entity type otherwise.
 */
function field_timer_entity_properties($entity_type = '') {
  $properties = module_invoke_all('field_timer_entity_properties');
  if (!empty($entity_type)) {
    return $properties[$entity_type];
  }
  return $properties;
}